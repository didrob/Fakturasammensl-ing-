<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASCO Faktura Sammensl√•ing (AI-drevet)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library to read .docx files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #drop-zone {
            border: 2px dashed #d1d5db;
            transition: border-color 0.3s, background-color 0.3s;
        }
        #drop-zone.dragover {
            border-color: #2563eb;
            background-color: #f0f9ff;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #2563eb;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #report-output, #report-output * {
                visibility: visible;
            }
            #report-output {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-slate-50">

    <div class="max-w-7xl mx-auto p-4 sm:p-8">
        <header class="text-center mb-10">
            <img src="https://www.ascoworld.com/uploads/ASCO-Logo-Small-1-1.png" alt="ASCO Logo" class="w-24 mx-auto mb-4">
            <h1 class="text-4xl font-bold text-slate-800">AI-drevet Verkt√∏y for Kostnadsoversikt</h1>
            <p class="text-slate-600 mt-2 text-lg">Transformer dine fakturaer til en interaktiv rapport p√• sekunder.</p>
        </header>

        <main>
            <!-- Upload Section -->
            <section class="bg-white p-8 rounded-xl shadow-lg mb-8 no-print">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <!-- Left Column: Image -->
                    <div class="hidden md:block">
                        <img src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?q=80&w=2070&auto=format&fit=crop" class="rounded-lg object-cover h-full w-full" alt="Data analysis illustration">
                    </div>
                    <!-- Right Column: Upload -->
                    <div>
                        <h2 class="text-2xl font-semibold text-slate-700 mb-4">Start her</h2>
                        <div id="drop-zone" class="w-full p-8 text-center rounded-lg bg-slate-50">
                            <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                            </svg>
                            <p class="mt-4 text-slate-500">Dra og slipp .docx-filer her, eller</p>
                            <input type="file" id="file-input" multiple accept=".docx" class="hidden">
                            <button onclick="document.getElementById('file-input').click()" class="mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                                Velg Filer
                            </button>
                            <div id="file-list" class="mt-4 text-sm text-slate-700"></div>
                        </div>
                        <div id="processing-feedback" class="text-center mt-6 hidden">
                            <div class="spinner mx-auto"></div>
                            <p class="text-slate-600 mt-2">AI-en analyserer dokumentene dine. Dette kan ta et √∏yeblikk...</p>
                        </div>
                        <div id="process-button-container" class="text-center mt-6">
                            <button id="process-btn" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition disabled:bg-gray-400 text-lg" disabled>
                                ‚ú® Generer Oversikt med AI
                            </button>
                            <div id="usage-counter" class="text-sm text-slate-500 mt-2"></div>
                        </div>
                         <div class="mt-4 text-center text-xs text-slate-400">
                            üîí All filbehandling skjer lokalt i din nettleser. Ingen data lastes opp til en server.
                        </div>
                    </div>
                </div>
            </section>

            <!-- Report Output Section -->
            <section id="report-container" class="hidden">
                 <div class="flex justify-between items-center mb-4 no-print">
                    <h2 class="text-2xl font-bold text-gray-800">Generert Oversikt</h2>
                    <button onclick="window.print()" class="bg-slate-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-800 transition">
                        üñ®Ô∏è Skriv ut til PDF
                    </button>
                </div>
                <div id="report-output">
                    <!-- The generated invoice overview will be injected here -->
                </div>
            </section>
        </main>
    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileListDiv = document.getElementById('file-list');
        const processBtn = document.getElementById('process-btn');
        const reportContainer = document.getElementById('report-container');
        const reportOutput = document.getElementById('report-output');
        const processingFeedback = document.getElementById('processing-feedback');
        const processButtonContainer = document.getElementById('process-button-container');
        const usageCounterDiv = document.getElementById('usage-counter');

        let filesToProcess = [];

        // --- Drag and Drop Logic ---
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const newFiles = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.docx'));
            handleFiles(newFiles);
        });
        fileInput.addEventListener('change', () => { handleFiles(Array.from(fileInput.files)); });

        function handleFiles(newFiles) {
            filesToProcess = [...filesToProcess, ...newFiles];
            updateFileList();
        }

        function updateFileList() {
            processBtn.disabled = filesToProcess.length === 0;
            if (filesToProcess.length === 0) {
                fileListDiv.innerHTML = '';
                return;
            }
            fileListDiv.innerHTML = '<p class="font-semibold mb-2">Valgte filer:</p>';
            const list = document.createElement('ul');
            list.className = 'list-disc list-inside text-left';
            filesToProcess.forEach(file => {
                const listItem = document.createElement('li');
                listItem.textContent = file.name;
                list.appendChild(listItem);
            });
            fileListDiv.appendChild(list);
        }

        // --- Daily Limit Logic ---
        const DAILY_LIMIT = 10;

        function getUsage() {
            const today = new Date().toISOString().split('T')[0];
            const usage = JSON.parse(localStorage.getItem('apiUsage')) || {};
            if (usage.date !== today) {
                return { date: today, count: 0 };
            }
            return usage;
        }

        function updateUsageDisplay() {
            const usage = getUsage();
            const remaining = DAILY_LIMIT - usage.count;
            usageCounterDiv.textContent = `Du har ${remaining} analyser igjen i dag.`;
        }

        function checkUsageLimit() {
            let usage = getUsage();
            if (usage.count >= DAILY_LIMIT) {
                alert(`Du har n√•dd den daglige grensen p√• ${DAILY_LIMIT} analyser. Pr√∏v igjen i morgen.`);
                return false;
            }
            usage.count++;
            localStorage.setItem('apiUsage', JSON.stringify(usage));
            updateUsageDisplay();
            return true;
        }

        // --- Processing Logic ---
        processBtn.addEventListener('click', async () => {
            if (filesToProcess.length === 0) return;
            
            if (!checkUsageLimit()) {
                return; // Stop if limit is reached
            }

            processingFeedback.classList.remove('hidden');
            processButtonContainer.classList.add('hidden');
            reportContainer.classList.add('hidden');

            let combinedText = "";
            for (const file of filesToProcess) {
                const arrayBuffer = await file.arrayBuffer();
                const text = await readFileAsText(arrayBuffer);
                combinedText += text + "\n\n--- NEW DOCUMENT ---\n\n";
            }

            try {
                const items = await callGeminiToParse(combinedText);
                renderReport(items);
                reportContainer.classList.remove('hidden');
            } catch (error) {
                console.error("Error processing with AI:", error);
                alert("En feil oppstod under AI-analysen. Vennligst pr√∏v igjen.");
            } finally {
                processingFeedback.classList.add('hidden');
                processButtonContainer.classList.remove('hidden');
            }
        });

        function readFileAsText(arrayBuffer) {
            return mammoth.extractRawText({ arrayBuffer }).then(result => result.value);
        }

        async function callGeminiToParse(text) {
            const apiKey = "AIzaSyAfe7f48N1x_FDU0nl1sW3z4lH0MRzilXU"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        description: { type: "STRING" },
                        date: { type: "STRING" },
                        qty: { type: "NUMBER" },
                        unit: { type: "STRING" },
                        unitPrice: { type: "NUMBER" },
                        amount: { type: "NUMBER" }
                    },
                    required: ["description", "date", "qty", "unit", "amount"]
                }
            };

            const systemPrompt = `You are a highly accurate data extraction tool. Your task is to analyze the provided invoice text, identify every single line item, and extract the specified data points. Also, identify any associated fees on the next line (like 'CO2 Avgift' or 'Milj√∏gebyr') and create separate line items for them, linking them to the parent item's date, quantity, and unit. You MUST return the data as a valid JSON array matching the provided schema. Do not return anything else.`;
            const userQuery = `Extract all invoice line items from the following text:\n\n${text}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema,
                }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API call failed with status: ${response.status}`);
            }
            
            const result = await response.json();
            const jsonText = result.candidates[0].content.parts[0].text;
            return JSON.parse(jsonText);
        }

        function categorize(description) {
            const desc = description.toLowerCase();
            if (desc.includes('residual') || desc.includes('restavfall') || desc.includes('co2')) return 'Residual Waste';
            if (desc.includes('wood') || desc.includes('trevirke')) return 'Wood Waste';
            if (desc.includes('metal') || desc.includes('jern')) return 'Metal Waste';
            if (desc.includes('plastic') || desc.includes('plast')) return 'Plastic Waste';
            if (desc.includes('ee-avfall') || desc.includes('weee')) return 'EE Waste';
            if (desc.includes('oily') || desc.includes('olje') || desc.includes('batteri') || desc.includes('spray') || desc.includes('fat') || desc.includes('ibc') || desc.includes('environmental fee')) return 'Hazardous Waste';
            if (desc.includes('trosse') || desc.includes('tauverk')) return 'Other Waste';
            return 'Services'; // Default
        }

        function renderReport(items) {
            items.forEach(item => item.category = categorize(item.description));

            const groupedByCategory = items.reduce((acc, item) => {
                acc[item.category] = acc[item.category] || [];
                acc[item.category].push(item);
                return acc;
            }, {});

            let tableHtml = '';
            let totalNetAmount = 0;
            let categoryTotals = {};
            const sortedCategories = Object.keys(groupedByCategory).sort();

            for (const category of sortedCategories) {
                const catItems = groupedByCategory[category];
                let categorySubtotal = 0;

                tableHtml += `<tr class="bg-gray-50"><td colspan="6" class="p-3 font-bold text-gray-700">${category}</td></tr>`;
                
                catItems.forEach(item => {
                    tableHtml += `
                        <tr>
                            <td class="p-3">${item.description}</td>
                            <td class="text-right p-3">${item.date}</td>
                            <td class="text-right p-3">${(item.qty || 0).toLocaleString('nb-NO')}</td>
                            <td class="text-right p-3">${item.unit}</td>
                            <td class="text-right p-3">${(item.unitPrice || 0).toFixed(2)}</td>
                            <td class="text-right p-3">${item.amount.toLocaleString('nb-NO', {minimumFractionDigits: 2})}</td>
                        </tr>`;
                    categorySubtotal += item.amount;
                });

                tableHtml += `
                    <tr class="border-b-2 border-gray-200">
                        <td colspan="5" class="text-right font-semibold p-3">Subtotal for ${category}</td>
                        <td class="text-right font-semibold p-3">${categorySubtotal.toLocaleString('nb-NO', {minimumFractionDigits: 2})}</td>
                    </tr>`;
                
                totalNetAmount += categorySubtotal;
                categoryTotals[category] = categorySubtotal;
            }

            let summaryHtml = `<h3 class="font-bold text-gray-800 mb-4">Cost Summary</h3>`;
            summaryHtml += `<div class="flex justify-between text-lg font-bold border-b pb-2 mb-2"><span>Total Net Amount</span><span>${totalNetAmount.toLocaleString('nb-NO', {minimumFractionDigits: 2})} NOK</span></div>`;
            summaryHtml += `<div class="space-y-1">`;
            for (const category of sortedCategories) {
                 summaryHtml += `
                    <div class="flex justify-between text-sm text-gray-600">
                        <span>${category}</span>
                        <span>${categoryTotals[category].toLocaleString('nb-NO', {minimumFractionDigits: 2})} NOK</span>
                    </div>`;
            }
            summaryHtml += `</div>`;

            const fullReportHtml = `
                <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-8 sm:p-12">
                    <header class="flex justify-between items-start pb-8 border-b">
                        <div>
                            <img src="https://www.ascoworld.com/uploads/ASCO-Logo-Small-1-1.png" alt="ASCO Logo" class="w-24 mb-4">
                            <p class="text-gray-600">Risavika Havnering 235</p>
                            <p class="text-gray-600">4056 Tananger</p>
                            <p class="text-gray-600">Telefon: 51 64 75 55</p>
                        </div>
                        <div class="text-right">
                            <h2 class="text-2xl font-bold text-gray-800 uppercase tracking-wide">Cost Overview</h2>
                            <div class="mt-2 text-sm text-gray-600">
                                <p><span class="font-semibold">Date:</span> ${new Date().toLocaleDateString('nb-NO')}</p>
                            </div>
                        </div>
                    </header>
                    <section class="mt-8 flex justify-between items-start">
                        <div class="w-1/2">
                            <h3 class="font-semibold text-gray-800">Client:</h3>
                            <p class="text-gray-600">Saipem</p>
                            <p class="text-gray-600">[Saipem's Address]</p>
                        </div>
                        <div class="w-1/2 bg-gray-50 p-6 rounded-lg border">${summaryHtml}</div>
                    </section>
                    <section class="mt-10">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Detailed Breakdown</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-100 border-b">
                                    <tr>
                                        <th class="text-left font-semibold p-3">Description</th>
                                        <th class="text-right font-semibold p-3">Date</th>
                                        <th class="text-right font-semibold p-3">Qty</th>
                                        <th class="text-right font-semibold p-3">Unit</th>
                                        <th class="text-right font-semibold p-3">Unit Price</th>
                                        <th class="text-right font-semibold p-3">Amount (NOK)</th>
                                    </tr>
                                </thead>
                                <tbody>${tableHtml}</tbody>
                            </table>
                        </div>
                    </section>
                </div>`;
            
            reportOutput.innerHTML = fullReportHtml;
        }

        // Initialize usage display on page load
        document.addEventListener('DOMContentLoaded', updateUsageDisplay);
    </script>
</body>
</html>
